<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AR Rangoli Viewer - Diwali Special</title>

  <!-- A-Frame + AR.js -->
  <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar.js"></script>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; overflow: hidden; }
    .ui-overlay { position: fixed; top: 0; left: 0; right: 0; z-index: 999; background: linear-gradient(135deg,#667eea,#764ba2); padding: 15px; box-shadow: 0 4px 6px rgba(0,0,0,.1); }
    .header { display: flex; justify-content: space-between; align-items: center; max-width: 1200px; margin: 0 auto; }
    .title { color: #fff; font-size: 24px; font-weight: 700; text-shadow: 2px 2px 4px rgba(0,0,0,.2); }
    .controls { display: flex; gap: 10px; align-items: center; }
    .btn, .rangoli-selector { background: #fff; color: #764ba2; border: none; padding: 10px 20px; border-radius: 25px; font-weight: 700; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,.1); }
    .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,.2); }
    .info-panel { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(255,255,255,.95); padding: 15px 25px; border-radius: 30px; box-shadow: 0 4px 15px rgba(0,0,0,.2); z-index: 998; text-align: center; }
    .info-text { color: #764ba2; font-size: 14px; font-weight: 500; }
    .diwali-badge { position: fixed; top: 80px; right: 20px; background: linear-gradient(45deg,#ff6b6b,#ffd93d); color: #fff; padding: 10px 20px; border-radius: 20px; font-weight: 700; box-shadow: 0 4px 10px rgba(0,0,0,.2); z-index: 997; }
    .instructions { position: fixed; top: 130px; right: 20px; background: rgba(255,255,255,.95); padding: 15px; border-radius: 10px; max-width: 250px; z-index: 996; box-shadow: 0 4px 10px rgba(0,0,0,.1); }
    .instructions h3 { color: #764ba2; margin-bottom: 10px; font-size: 16px; }
    .instructions ul { color: #555; font-size: 14px; padding-left: 20px; }
  </style>
</head>
<body>
  <div class="ui-overlay">
    <div class="header">
      <div class="title">ü™î AR Rangoli Viewer</div>
      <div class="controls">
        <select class="rangoli-selector" id="rangoliSelector">
          <option value="pattern1">Floral Rangoli</option>
          <option value="pattern2">Geometric Rangoli</option>
          <option value="pattern3">Peacock Rangoli</option>
          <option value="pattern4">Mandala Rangoli</option>
          <option value="pattern5">Diya Rangoli</option>
        </select>
        <button class="btn" onclick="placeRangoli()">Place Rangoli</button>
        <button class="btn" onclick="clearAllRangoli()">Clear All</button>
        <button class="btn" onclick="captureScreen()">üì∏ Capture</button>
      </div>
    </div>
  </div>

  <div class="diwali-badge">‚ú® Happy Diwali! ‚ú®</div>

  <div class="instructions">
    <h3>How to Use:</h3>
    <ul>
      <li>Allow camera access</li>
      <li>Point camera at a <b>hiro marker</b></li>
      <li>Select rangoli pattern</li>
      <li>Tap "Place Rangoli"</li>
    </ul>
  </div>

  <div class="info-panel"><div class="info-text">Point your camera at a hiro marker and tap ‚ÄúPlace Rangoli‚Äù.</div></div>

  <!-- IMPORTANT: Add a marker and place your objects inside it -->
  <a-scene
    embedded
    screenshot
    arjs="sourceType: webcam; trackingMethod: best; detectionMode: mono; debugUIEnabled: false;"
    renderer="logarithmicDepthBuffer: true; precision: medium; antialias: true; alpha: true;">

    <a-assets>
      <a-mixin id="rangoli-animation"
               animation__rotate="property: rotation; to: 0 360 0; loop: true; dur: 20000; easing: linear"
               animation__float="property: position; to: 0 0.1 0; dir: alternate; dur: 2000; loop: true; easing: easeInOutSine">
      </a-mixin>
    </a-assets>

    <!-- Marker anchor -->
    <a-marker preset="hiro" id="marker">
      <!-- Put rangolis under the marker so they stay attached -->
      <a-entity id="rangoli-container"></a-entity>
    </a-marker>

    <a-entity camera></a-entity>
  </a-scene>

  <script>
    let rangoliCount = 0;

    // Show a helpful message when marker is found/lost
    const marker = document.getElementById('marker');
    const infoText = document.querySelector('.info-text');
    marker.addEventListener('markerFound', () => infoText.textContent = 'Marker found! Tap "Place Rangoli".');
    marker.addEventListener('markerLost',  () => infoText.textContent = 'Point your camera at the hiro marker.');

    function createRangoliPattern(type, parent) {
      // parent is the rangoli <a-entity> under the marker
      switch(type) {
        case 'pattern1': createFloralRangoli(parent); break;
        case 'pattern2': createGeometricRangoli(parent); break;
        case 'pattern3': createPeacockRangoli(parent); break;
        case 'pattern4': createMandalaRangoli(parent); break;
        case 'pattern5': createDiyaRangoli(parent); break;
      }
      parent.setAttribute('animation__rotate', { property: 'rotation', to: '0 360 0', loop: true, dur: 30000, easing: 'linear' });
    }

    function createFloralRangoli(parent) {
      const center = document.createElement('a-circle');
      center.setAttribute('radius', '0.12');
      center.setAttribute('color', '#ff6b6b');
      center.setAttribute('rotation', '-90 0 0');
      center.setAttribute('opacity', '0.9');
      parent.appendChild(center);

      for (let i = 0; i < 8; i++) {
        const angle = (i * 45) * Math.PI/180;
        const petal = document.createElement('a-circle');
        petal.setAttribute('radius', '0.08');
        petal.setAttribute('color', i % 2 === 0 ? '#ffd93d' : '#ff9ff3');
        petal.setAttribute('position', { x: Math.cos(angle) * 0.25, y: 0, z: Math.sin(angle) * 0.25 });
        petal.setAttribute('rotation', '-90 0 0');
        petal.setAttribute('opacity', '0.85');
        parent.appendChild(petal);
      }
    }

    function createGeometricRangoli(parent) {
      const colors = ['#ee5a6f', '#f8b500', '#4a7c7e', '#8b5cf6'];
      for (let i = 0; i < 6; i++) {
        const angle = (i * 60) * Math.PI/180;
        const tri = document.createElement('a-triangle');
        tri.setAttribute('color', colors[i % colors.length]);
        tri.setAttribute('position', { x: Math.cos(angle) * 0.2, y: 0, z: Math.sin(angle) * 0.2 });
        tri.setAttribute('rotation', `-90 0 ${i * 60}`);
        tri.setAttribute('scale', '0.16 0.16 0.16');
        tri.setAttribute('opacity', '0.85');
        parent.appendChild(tri);
      }
    }

    function createPeacockRangoli(parent) {
      const body = document.createElement('a-sphere');
      body.setAttribute('radius', '0.12');
      body.setAttribute('color', '#4a7c7e');
      body.setAttribute('opacity', '0.9');
      parent.appendChild(body);

      for (let i = 0; i < 5; i++) {
        const angle = (i * 36 - 90) * Math.PI/180;
        const feather = document.createElement('a-cylinder');
        feather.setAttribute('radius', '0.02');
        feather.setAttribute('height', '0.24');
        feather.setAttribute('color', i % 2 === 0 ? '#22d3ee' : '#10b981');
        feather.setAttribute('position', { x: Math.cos(angle) * 0.22, y: 0.12, z: Math.sin(angle) * 0.22 });
        feather.setAttribute('rotation', `0 0 ${i * 36 - 90}`);
        feather.setAttribute('opacity', '0.85');
        parent.appendChild(feather);
      }
    }

    function createMandalaRangoli(parent) {
      const radii = [0.24, 0.18, 0.12, 0.06];
      const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#fdcb6e'];
      radii.forEach((radius, i) => {
        const ring = document.createElement('a-ring');
        ring.setAttribute('radius-inner', i > 0 ? radii[i] - 0.02 : 0);
        ring.setAttribute('radius-outer', radius);
        ring.setAttribute('color', colors[i]);
        ring.setAttribute('rotation', '-90 0 0');
        ring.setAttribute('opacity', '0.75');
        parent.appendChild(ring);
      });
    }

    function createDiyaRangoli(parent) {
      const base = document.createElement('a-cone');
      base.setAttribute('radius-bottom', '0.12');
      base.setAttribute('radius-top', '0.08');
      base.setAttribute('height', '0.08');
      base.setAttribute('color', '#d97706');
      base.setAttribute('opacity', '0.9');
      base.setAttribute('rotation', '-90 0 0'); // lay flat
      parent.appendChild(base);

      const flame = document.createElement('a-cone');
      flame.setAttribute('radius-bottom', '0.04');
      flame.setAttribute('radius-top', '0');
      flame.setAttribute('height', '0.12');
      flame.setAttribute('color', '#fbbf24');
      flame.setAttribute('position', '0 0.12 0');
      flame.setAttribute('opacity', '0.95');
      flame.setAttribute('animation__flicker', { property: 'scale', to: '1.1 1.2 1.1', dir: 'alternate', dur: 500, loop: true, easing: 'easeInOutSine' });
      parent.appendChild(flame);
    }

    function placeRangoli() {
      const selected = document.getElementById('rangoliSelector').value;

      // Place within ~40 cm of marker center
      const x = (Math.random() - 0.5) * 0.4;
      const z = (Math.random() - 0.5) * 0.4;

      const container = document.getElementById('rangoli-container');
      const rangoli = document.createElement('a-entity');
      rangoli.setAttribute('position', `${x} 0 ${z}`);
      createRangoliPattern(selected, rangoli);
      container.appendChild(rangoli);

      rangoliCount++;
      infoText.textContent = `Rangoli placed! Total: ${rangoliCount}.`;
    }

    function clearAllRangoli() {
      document.getElementById('rangoli-container').innerHTML = '';
      rangoliCount = 0;
      infoText.textContent = 'All rangoli cleared. Place new ones!';
    }

    function captureScreen() {
      const scene = document.querySelector('a-scene');
      // Use the screenshot *system* (reliable)
      const canvas = scene.systems.screenshot.getCanvas('perspective');
      const link = document.createElement('a');
      link.href = canvas.toDataURL('image/png');
      link.download = `ar-rangoli-${Date.now()}.png`;
      link.click();
      infoText.textContent = 'Screenshot captured! Check your downloads.';
    }
  </script>
</body>
</html>
